{% extends "base.html" %}
{% load static %}

{% block title %}لوحة الأخصائي{% endblock %}

{% block extra_head %}
<style>
  :root{
    --bg:#f6f8fb; --text:#1f2937; --muted:#6b7280;
    --primary:#4e73df; --primary-600:#2e59d9;
    --chip-bg:#eef2ff; --chip-bd:#d0d7ff; --chip-t:#1e2a78;
    --ok-bg:#e8f7ee; --ok:#117a38;
    --warn-bg:#fff4e5; --warn:#a15c07;
    --bad-bg:#fdeaea; --bad:#a1231e;
    --card:#fff; --bd:#e5e7eb; --shadow:0 2px 10px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  body{font-family:Tahoma,Arial;background:var(--bg);color:var(--text);margin:0}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:26px}
  .card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:16px;margin-bottom:14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:14px}
  .muted{color:var(--muted)}
  .btn{display:inline-flex;align-items:center;gap:6px;background:var(--primary);color:#fff;border:none;border-radius:10px;padding:10px 14px;text-decoration:none;cursor:pointer}
  .btn:hover{background:var(--primary-600)}
  .btn--ghost{background:#fff;color:var(--primary);border:1px solid var(--chip-bd)}
  .btn--success{background:var(--ok);color:#fff}
  .btn--danger{background:#e74a3b;color:#fff}
  .avatar{width:40px;height:40px;border-radius:50%;background:#eef2ff;color:#3243a3;display:flex;align-items:center;justify-content:center;font-weight:700}
  .child-head{display:flex;align-items:center;gap:10px}
  .name{font-weight:800}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  /* chips */
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;background:var(--chip-bg);color:var(--chip-t);text-decoration:none;border:1px solid var(--chip-bd)}
  .chip:hover{background:#e6ecff}
  .chip--outline{background:#fff;border:1px dashed var(--chip-bd);color:#3243a3}
  .badge{font-size:11px;padding:2px 8px;border-radius:999px}
  .badge--completed{background:var(--ok-bg);color:var(--ok)}
  .badge--active{background:var(--warn-bg);color:var(--warn)}
  .badge--aborted{background:var(--bad-bg);color:var(--bad)}
  .empty{color:var(--muted);margin-top:6px}
  /* list (طلبات) */
  .list{list-style:none;margin:0;padding:0;border:1px solid var(--bd);border-radius:12px;overflow:hidden}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border-bottom:1px solid #eef2f7;background:#fff}
  .row:last-child{border-bottom:none}
  .row-main{display:flex;align-items:center;gap:10px}
  .row-actions{display:flex;gap:8px}
  /* رسائل Django (اختياري) */
  .msgs{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
  .msg{padding:10px 12px;border-radius:10px}
  .msg--ok{background:var(--ok-bg);color:var(--ok)}
  .msg--info{background:#eef6ff;color:#0b56a7}
  .msg--err{background:var(--bad-bg);color:var(--bad)}
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <header>
    <h1>مرحبًا {{ request.user.username }} — لوحة الأخصائي</h1>
  </header>

  {# رسائل فلاش إن وُجدت #}
  {% if messages %}
    <div class="msgs">
      {% for m in messages %}
        <div class="msg {% if m.tags == 'success' %}msg--ok{% elif m.tags == 'error' %}msg--err{% else %}msg--info{% endif %}">
          {{ m }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- الحالات (الأطفال المرتبطون بالأخصائي) -->
  <section class="card">
    <h3 style="margin:0 0 10px">حالاتي</h3>
    {% if patients %}
      <div class="grid">
        {% for c in patients %}
          <div class="card" style="margin:0">
            <div class="child-head">
              <div class="avatar">{{ c.username|slice:":1" }}</div>
              <div>
                <div class="name">{{ c.username }}</div>
                <div class="muted">وليّ الأمر: {{ c.parent.username|default:"غير محدد" }}</div>
              </div>
            </div>

            <div class="actions">
              <a class="btn" href="{% url 'child_skills_overview' c.id %}">عرض تقرير آخر جلسة</a>
            </div>

            {% with sessions=c.assessment_sessions.all %}
              {% if sessions %}
                <div class="chips">
                  {% for s in sessions %}
                    <a class="chip" href="{% url 'child_skills_overview' c.id %}?session_id={{ s.id }}">
                      جلسة {{ s.started_at|date:"Y-m-d" }}{% if s.ended_at %} — {{ s.ended_at|date:"H:i" }}{% endif %}
                      <span class="badge {% if s.status == 'completed' %}badge--completed{% elif s.status == 'active' %}badge--active{% else %}badge--aborted{% endif %}">
                        {{ s.get_status_display }}
                      </span>
                      <span class="badge badge--completed" style="margin-inline-start:6px;">
                        {{ s.duration_human }}
                      </span>
                    </a>
                  {% endfor %}
                  <a class="chip chip--outline" href="{% url 'child_skills_overview' c.id %}?session_id=all">جميع الجلسات</a>
                </div>
              {% else %}
                <div class="empty">لا توجد جلسات بعد.</div>
              {% endif %}
            {% endwith %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted" style="margin:6px 0 0">لا توجد حالات مرتبطة بك حتى الآن.</p>
    {% endif %}
  </section>

  <!-- طلبات المتابعة الواردة -->
  <section class="card">
    <h3 style="margin:0 0 10px">طلبات المتابعة الواردة</h3>
    {% if pending %}
      <ul class="list">
        {% for r in pending %}
          <li class="row">
            <div class="row-main">
              <div class="avatar">{{ r.child.username|slice:":1" }}</div>
              <div>
                <div><strong>{{ r.child.username }}</strong></div>
                <div class="muted">
                  من: {% if r.created_by %}{{ r.created_by.username }}{% else %}النظام{% endif %} —
                  {{ r.created_at|date:"Y-m-d H:i" }}
                </div>
              </div>
            </div>
            <div class="row-actions">
              <a class="btn btn--success" href="{% url 'approve_link' r.pk %}">قبول</a>
              <a class="btn btn--danger" href="{% url 'reject_link' r.pk %}">رفض</a>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted" style="margin:6px 0 0">لا توجد طلبات جديدة.</p>
    {% endif %}
  </section>
</div>
{% endblock %}
