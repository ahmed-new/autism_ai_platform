<!-- skill_detail.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}تقرير مهارة — {{ detail.skill_name }}{% endblock %}

{% block extra_head %}
<style>
  body{font-family:Tahoma,Arial;background:#f7f9fc}
  .page-wrap{padding:24px}
  h2{margin:0 0 6px}
  .sub{color:#667085;margin:0 0 16px}
  .card{background:#fff;border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .kpi{font-size:28px;margin:0}
  .tag{padding:4px 8px;border-radius:999px;font-size:12px;color:#fff;display:inline-block}
  .w{background:#e74a3b}            /* تحتاج تحسين */
  .g{background:#f1c40f;color:#222}  /* جيدة */
  .s{background:#2ecc71}            /* قوية */
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;vertical-align:top}
  th{background:#f1f3f8}
  .qtxt{text-align:right;white-space:normal;word-wrap:break-word;max-width:720px}
</style>
{% endblock %}

{% block content %}
<div class="page-wrap">

  <h2>تقرير مهارة: {{ detail.skill_name }} — {{ child.username }}</h2>
  {% if session %}
    <p class="sub">
      جلسة #{{ session.id }} —
      من {{ session.started_at|date:"Y-m-d H:i" }}
      إلى {{ session.ended_at|date:"Y-m-d H:i" }}
       — <strong>المدة: {{ session.duration_human }}</strong>
      — الحالة: {{ session.get_status_display }}
    </p>
  {% else %}
    <p class="sub">بدون تحديد جلسة (إجمالي جميع الجلسات)</p>
  {% endif %}

  <div class="grid">
    <div class="card">
      <div>الدقة (موزونة):</div>
      <div class="kpi">{{ detail.accuracy_pct }}%</div>
    </div>
    <div class="card">
      <div>الانتباه (WebGazer):</div>
      <div class="kpi">{{ detail.attention_pct }}%</div>
    </div>
    <div class="card">
      <div>الحالة:</div>
      <div>
        {% if detail.level == 'needs_improvement' %}
          <span class="tag w">تحتاج تحسين</span>
        {% elif detail.level == 'strong' %}
          <span class="tag s">قوية</span>
        {% else %}
          <span class="tag g">جيدة</span>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card">
    <h3>توزيع الأداء حسب الصعوبة</h3>
    {% with d1=detail.distribution_by_difficulty.1 d2=detail.distribution_by_difficulty.2 d3=detail.distribution_by_difficulty.3 %}
    <table>
      <thead>
        <tr><th>الصعوبة</th><th>إجمالي</th><th>صح</th><th>غلط</th><th>دقة %</th></tr>
      </thead>
      <tbody>
        <tr><td>سهل</td><td>{{ d1.total }}</td><td>{{ d1.correct }}</td><td>{{ d1.wrong }}</td><td>{{ d1.acc_pct }}%</td></tr>
        <tr><td>متوسط</td><td>{{ d2.total }}</td><td>{{ d2.correct }}</td><td>{{ d2.wrong }}</td><td>{{ d2.acc_pct }}%</td></tr>
        <tr><td>صعب</td><td>{{ d3.total }}</td><td>{{ d3.correct }}</td><td>{{ d3.wrong }}</td><td>{{ d3.acc_pct }}%</td></tr>
      </tbody>
    </table>
    {% endwith %}
  </div>

  <div class="card">
    <h3>أضعف الأسئلة داخل هذه المهارة</h3>
    <table>
      <thead>
        <tr><th>السؤال</th><th>الصعوبة</th><th>دقة السؤال</th><th>انتباه</th></tr>
      </thead>
      <tbody>
        {% for q in detail.weakest_questions %}
        <tr>
          <td class="qtxt">{{ q.question_text|default:"—" }}</td>
          <td>{% if q.difficulty == 1 %}سهل{% elif q.difficulty == 2 %}متوسط{% else %}صعب{% endif %}</td>
          <td>{{ q.acc_pct }}%</td>
          <td>{{ q.attention_pct }}%</td>
        </tr>
        {% empty %}
          <tr><td colspan="4">لا توجد أسئلة كافية لتحديد نقاط الضعف.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>
{% endblock %}
