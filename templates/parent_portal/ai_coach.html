{% extends "base.html" %}
{% load static %}

{% block title %}المساعد الذكي — {{ child.username }}{% endblock %}

{% block extra_head %}
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --txt:#1f2937; --muted:#667085;
    --bd:#e5e7eb; --primary:#4e73df; --primary-600:#2e59d9;
    --chip:#eef2ff; --chip-bd:#d7ddff;
  }
  body{background:var(--bg);color:var(--txt);font-family:Tahoma,Arial;margin:0}
  .wrap{max-width:960px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px;margin-bottom:14px}
  .title{margin:0 0 8px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-bd)}
  .chip input{accent-color:#4e73df}
  textarea{width:100%;min-height:110px;border:1px solid var(--bd);border-radius:12px;padding:10px}
  .btn{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn:hover{background:var(--primary-600)}
  .pill{display:inline-flex;padding:2px 8px;border-radius:999px;background:#eef2ff;border:1px solid #d7ddff}

  /* تحسين مظهر ردّ الذكاء */
  pre{
    white-space:pre-wrap;
    line-height:1.9;
    font-size:16.5px;
    font-family: Tahoma, Arial, "Segoe UI", sans-serif;
    color:#111827;
    background:#fbfcff;
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding:14px;
    margin:0;
  }
  /* لو الموديل رجّع عناوين Markdown كنص، تبان أكبر قليلًا داخل pre */
  pre h1, pre h2, pre h3 { margin: .4em 0 .2em; font-weight:700; }
  pre h1{font-size:1.25em} pre h2{font-size:1.18em} pre h3{font-size:1.12em}
  pre ul, pre ol{margin:.5em 1.4em}
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="card">
    <h2 class="title">المساعد الذكي — {{ child.username }}</h2>
    {% if session %}
      <div class="muted">
        جلسة محورية: #{{ session.id }} — {{ session.started_at|date:"Y-m-d H:i" }}
        {% if session.ended_at %}— {{ session.ended_at|date:"H:i" }}{% endif %}
        — <strong>المدة: {{ session.duration_human }}</strong>
        <span class="pill">{{ session.get_status_display }}</span>
      </div>
    {% else %}
      <div class="muted">لا توجد جلسة محددة؛ سيتم التحليل على إجمالي البيانات المتاحة.</div>
    {% endif %}
  </div>

  <div class="card">
    <h3 class="title">اختر مهارات الجلسة للتركيز (اختياري)</h3>
    {% if focus_skills %}
      <form method="post">
        {% csrf_token %}
        <div class="chips">
          {% for s in focus_skills %}
            <label class="chip">
              <input type="checkbox" name="focus[]" value="{{ s.id }}">
              {{ s.name }}
            </label>
          {% endfor %}
        </div>

        <div style="margin-top:12px">
          <label class="muted">رسالة للمساعد (اختياري):</label>
          <textarea name="message" placeholder="مثال: ركّز على زيادة التواصل اللفظي وتقليل التكرار."></textarea>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" type="submit" name="ask">اطلب الخطة</button>
          <!-- <button class="btn" type="submit" name="continue" value="1">متابعة الرد</button> -->
        </div>
      </form>
    {% else %}
      <div class="muted">لم تُسجّل مهارات مُختبرة في هذه الجلسة بعد.</div>
    {% endif %}
  </div>

  {% if ai_answer %}
    <div class="card">
      <h3 class="title">اقتراحات المساعد</h3>
      <pre>{{ ai_answer }}</pre>
    </div>
  {% endif %}

  <div class="card">
    <h3 class="title">نظرة عامة مختصرة حسب مجموعة المهارات</h3>
    {% if groups %}
      <div class="row" style="gap:8px">
        {% for g in groups %}
          <span class="chip">
            {{ g.group_name }} — دقة {{ g.accuracy_pct }}% / انتباه {{ g.attention_pct }}%
          </span>
        {% endfor %}
      </div>
    {% else %}
      <div class="muted">لا توجد بيانات كافية للعرض.</div>
    {% endif %}
  </div>

</div>
{% endblock %}
